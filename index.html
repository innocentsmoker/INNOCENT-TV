<script>
    // DOM elements
    const moviesGrid = document.getElementById('movies-grid');
    const loadingElement = document.getElementById('loading');
    const emptyStateElement = document.getElementById('empty-state');
    const searchBox = document.querySelector('.search-box');
    const movieModal = document.getElementById('movie-modal');
    const modalClose = document.getElementById('modal-close');

    // Modal elements
    const modalBackdrop = document.getElementById('modal-backdrop');
    const modalPoster = document.getElementById('modal-poster');
    const modalTitle = document.getElementById('modal-title');
    const modalYear = document.getElementById('modal-year');
    const modalRating = document.getElementById('modal-rating');
    const modalRuntime = document.getElementById('modal-runtime');
    const modalOverview = document.getElementById('modal-overview');
    const modalDirector = document.getElementById('modal-director');
    const modalGenre = document.getElementById('modal-genre');
    const modalCast = document.getElementById('modal-cast');

    // Debounce utility
    const debounce = (fn, delay) => {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => fn(...args), delay);
        };
    };

    // Display movies in grid
    function displayMovies(movies) {
        moviesGrid.innerHTML = '';

        if (!movies || movies.length === 0) {
            emptyStateElement.style.display = 'block';
            return;
        }

        emptyStateElement.style.display = 'none';

        movies.forEach(movie => {
            const poster = movie.thumb || movie.art || 'https://via.placeholder.com/300x450?text=No+Image';
            const year = movie.year || 'Unknown';
            const summary = movie.summary || 'No description available.';
            const genres = movie.genre || [];

            const movieCard = document.createElement('div');
            movieCard.className = 'movie-card';
            movieCard.innerHTML = `
                <img src="${poster}" alt="${movie.title}" class="movie-poster">
                <div class="movie-info">
                    <h3 class="movie-title">${movie.title}</h3>
                    <div class="movie-year">${year}</div>
                    <p class="movie-summary">${summary}</p>
                    <div class="movie-tags">
                        ${genres.map(g => `<span class="tag">${g}</span>`).join('')}
                    </div>
                    <div class="movie-actions">
                        <button class="btn btn-primary view-details" data-movie='${JSON.stringify(movie)}'>View Details</button>
                    </div>
                </div>
            `;
            moviesGrid.appendChild(movieCard);
        });

        document.querySelectorAll('.view-details').forEach(button => {
            button.addEventListener('click', function () {
                const movie = JSON.parse(this.getAttribute('data-movie'));
                openMovieModal(movie);
            });
        });
    }

    // Open modal with movie details
    function openMovieModal(movie) {
        modalBackdrop.style.backgroundImage = `url('${movie.art || movie.thumb || ''}')`;
        modalPoster.src = movie.thumb || movie.art || 'https://via.placeholder.com/300x450?text=No+Image';
        modalTitle.textContent = movie.title;
        modalYear.textContent = movie.year || 'Unknown';
        modalRating.textContent = movie.rating ? `${movie.rating}/10` : 'N/A';
        modalRuntime.textContent = movie.duration ? `${Math.floor(movie.duration / 60)} min` : 'N/A';
        modalOverview.textContent = movie.summary || 'No description available.';
        modalDirector.textContent = movie.director || 'Unknown';
        modalGenre.textContent = (movie.genre || []).join(', ');

        modalCast.innerHTML = '';
        if (movie.roles && movie.roles.length > 0) {
            movie.roles.forEach(actor => {
                const castMember = document.createElement('div');
                castMember.className = 'cast-member';
                castMember.innerHTML = `
                    <div class="cast-photo"></div>
                    <div class="cast-name">${actor.tag}</div>
                `;
                modalCast.appendChild(castMember);
            });
        } else {
            modalCast.innerHTML = '<p>No cast information available.</p>';
        }

        movieModal.style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    // Close modal
    function closeMovieModal() {
        movieModal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    // Fetch movies from Plex API
    async function fetchMovies(query = '') {
        loadingElement.style.display = 'block';
        emptyStateElement.style.display = 'none';
        moviesGrid.innerHTML = '';

        try {
            const res = await fetch(`https://casper-tech-apis.vercel.app/api/movie/plex/search?query=${encodeURIComponent(query)}`);
            const data = await res.json();

            if (data && data.results) {
                displayMovies(data.results);
            } else {
                emptyStateElement.style.display = 'block';
            }
        } catch (error) {
            console.error('Error fetching movies:', error);
            emptyStateElement.style.display = 'block';
        } finally {
            loadingElement.style.display = 'none';
        }
    }

    // Fetch trending movies by default
    async function fetchTrendingMovies() {
        loadingElement.style.display = 'block';
        try {
            // Use a common keyword to simulate trending (API doesnâ€™t provide trending endpoint)
            const res = await fetch(`https://casper-tech-apis.vercel.app/api/movie/plex/search?query=popular`);
            const data = await res.json();
            if (data && data.results && data.results.length > 0) {
                displayMovies(data.results);
            } else {
                emptyStateElement.style.display = 'block';
            }
        } catch (error) {
            console.error('Error fetching trending movies:', error);
            emptyStateElement.style.display = 'block';
        } finally {
            loadingElement.style.display = 'none';
        }
    }

    // Initialize
    fetchTrendingMovies();

    // Search handler
    searchBox.addEventListener('input', debounce(function () {
        const query = this.value.trim();
        if (query.length > 0) {
            fetchMovies(query);
        } else {
            fetchTrendingMovies();
        }
    }, 500));

    // Modal controls
    modalClose.addEventListener('click', closeMovieModal);
    movieModal.addEventListener('click', (event) => {
        if (event.target === movieModal) closeMovieModal();
    });
    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') closeMovieModal();
    });

    // Footer year auto-update (optional)
    const yearEl = document.getElementById("year");
    if (yearEl) yearEl.textContent = new Date().getFullYear();
</script>
